import{aw as G,a0 as J,r,j as e,a3 as R,a4 as K,bU as Q,b0 as B,x as X,ap as Z,bR as ee,bV as se,ad as te,a$ as ae,a as ne,t as m}from"./vendor-react-BtnKiOrb.js";import{p as b}from"./python-strategy-CDEXs7wP.js";import{A as re,a as ie}from"./alert-wYC2wlrk.js";import{B as o,e as S,D as le,i as oe,j as ce,k as I}from"./index-B87L8flj.js";import{C as M,b as U,c as $,a as A}from"./card-DaWziHEX.js";import{S as C}from"./skeleton-CrtzJpAL.js";function je(){const{strategyId:c}=G(),_=J(),[h,O]=r.useState(null),[u,P]=r.useState(null),[a,g]=r.useState(""),[N,k]=r.useState(""),[V,E]=r.useState(!0),[p,D]=r.useState(!1),[d,F]=r.useState(()=>localStorage.getItem("editor-theme")==="dark"),[j,y]=r.useState(!1),l=a!==N,n=h?.status==="running",W=async()=>{if(c)try{E(!0);const[t,s]=await Promise.all([b.getStrategy(c),b.getStrategyContent(c)]);O(t),P(s),g(s.content),k(s.content)}catch(t){console.error("Failed to fetch strategy:",t),m.error("Failed to load strategy"),_("/python")}finally{E(!1)}};r.useEffect(()=>{W()},[]),r.useEffect(()=>{localStorage.setItem("editor-theme",d?"dark":"light")},[d]),r.useEffect(()=>{const t=s=>{(s.ctrlKey||s.metaKey)&&s.key==="s"&&(s.preventDefault(),l&&!n&&v()),s.key==="F11"&&(s.preventDefault(),y(i=>!i)),s.key==="Escape"&&j&&y(!1)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[l,n,j]);const v=async()=>{if(!(!c||!l||n))try{D(!0);const t=await b.saveStrategy(c,a);t.status==="success"?(k(a),m.success("Strategy saved")):m.error(t.message||"Failed to save strategy")}catch(t){console.error("Failed to save strategy:",t),m.error("Failed to save strategy")}finally{D(!1)}},H=()=>{g(N),m.info("Changes discarded")},z=async t=>{if(!(!c||!h))try{const s=await b.exportStrategy(c,t),i=URL.createObjectURL(s),x=document.createElement("a");x.href=i,x.download=h.file_name,document.body.appendChild(x),x.click(),document.body.removeChild(x),URL.revokeObjectURL(i),m.success("Strategy exported")}catch(s){console.error("Failed to export strategy:",s),m.error("Failed to export strategy")}},Y=r.useCallback(t=>{if(t.key==="Tab"){t.preventDefault();const s=t.target,i=s.selectionStart,x=s.selectionEnd;if(t.shiftKey){const f=a.substring(0,i).lastIndexOf(`
`)+1,L=a.substring(f,i);if(L.startsWith("    ")){const w=a.substring(0,f)+a.substring(f+4);g(w),setTimeout(()=>{s.selectionStart=s.selectionEnd=i-4},0)}else if(L.startsWith("	")){const w=a.substring(0,f)+a.substring(f+1);g(w),setTimeout(()=>{s.selectionStart=s.selectionEnd=i-1},0)}}else{const T=`${a.substring(0,i)}    ${a.substring(x)}`;g(T),setTimeout(()=>{s.selectionStart=s.selectionEnd=i+4},0)}}},[a]);if(V)return e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsx(C,{className:"h-8 w-32"}),e.jsx(C,{className:"h-12"}),e.jsx(C,{className:"h-[600px]"})]});if(!h||!u)return null;const q=e.jsxs("div",{className:`relative ${j?"fixed inset-0 z-50 bg-background p-4":""}`,children:[j&&e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:h.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:()=>F(!d),children:d?e.jsx(R,{className:"h-4 w-4"}):e.jsx(K,{className:"h-4 w-4"})}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>y(!1),children:e.jsx(Q,{className:"h-4 w-4"})}),e.jsxs(o,{size:"sm",onClick:v,disabled:!l||p||n,className:l&&!n?"animate-pulse":"",children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),p?"Saving...":"Save"]})]})]}),e.jsx("textarea",{value:a,onChange:t=>g(t.target.value),onKeyDown:Y,readOnly:n,className:`w-full font-mono text-sm p-4 rounded-lg border focus:outline-none focus:ring-2 focus:ring-primary resize-none ${d?"bg-gray-900 text-gray-100 border-gray-700":"bg-white text-gray-900 border-gray-300"} ${j?"h-[calc(100vh-120px)]":"min-h-[600px]"} ${n?"opacity-75 cursor-not-allowed":""}`,spellCheck:!1,placeholder:"# Your Python strategy code here..."}),e.jsxs("div",{className:"flex items-center justify-between mt-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Lines: ",a.split(`
`).length," • Size: ",(new Blob([a]).size/1024).toFixed(2)," KB"]}),e.jsx("span",{children:l?e.jsx(S,{variant:"outline",className:"text-yellow-500 border-yellow-500",children:"Unsaved Changes"}):e.jsx(S,{variant:"outline",className:"text-green-500 border-green-500",children:"Saved"})})]})]});return e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsx(o,{variant:"ghost",asChild:!0,children:e.jsxs(X,{to:"/python",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Back to Python Strategies"]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold tracking-tight flex items-center gap-3",children:[n?"View":"Edit"," Strategy",n&&e.jsx(S,{className:"bg-green-500",children:"Running"})]}),e.jsxs("p",{className:"text-muted-foreground flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),h.name," • ",u.file_name]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:()=>F(!d),children:d?e.jsx(R,{className:"h-4 w-4"}):e.jsx(K,{className:"h-4 w-4"})}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>y(!0),children:e.jsx(se,{className:"h-4 w-4"})}),e.jsxs(le,{children:[e.jsx(oe,{asChild:!0,children:e.jsxs(o,{variant:"outline",size:"sm",children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Export"]})}),e.jsxs(ce,{children:[e.jsx(I,{onClick:()=>z("saved"),children:"Saved Version"}),e.jsx(I,{onClick:()=>z("current"),children:"Current Content"})]})]}),e.jsxs(o,{variant:"outline",size:"sm",onClick:H,disabled:!l,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Reset"]}),e.jsxs(o,{size:"sm",onClick:v,disabled:!l||p||n,className:l&&!n?"animate-pulse":"",children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),p?"Saving...":"Save"]})]})]}),n&&e.jsxs(re,{children:[e.jsx(ne,{className:"h-4 w-4"}),e.jsx(ie,{children:"This strategy is currently running. The editor is in read-only mode. Stop the strategy to make changes."})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["File: ",u.file_name]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:[u.line_count," lines"]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:[u.size_kb.toFixed(2)," KB"]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Last modified: ",new Date(u.last_modified).toLocaleString()]})]}),e.jsxs(M,{children:[e.jsx(U,{className:"pb-2",children:e.jsxs($,{className:"text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Code Editor"}),e.jsx("span",{className:"font-normal text-xs text-muted-foreground",children:"Ctrl+S to save • F11 for fullscreen • Tab to indent"})]})}),e.jsx(A,{children:q})]}),e.jsxs(M,{children:[e.jsx(U,{className:"pb-2",children:e.jsx($,{className:"text-sm",children:"Keyboard Shortcuts"})}),e.jsx(A,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("kbd",{className:"px-2 py-1 bg-muted rounded",children:"Ctrl+S"})," Save"]}),e.jsxs("div",{children:[e.jsx("kbd",{className:"px-2 py-1 bg-muted rounded",children:"Tab"})," Indent"]}),e.jsxs("div",{children:[e.jsx("kbd",{className:"px-2 py-1 bg-muted rounded",children:"Shift+Tab"})," Unindent"]}),e.jsxs("div",{children:[e.jsx("kbd",{className:"px-2 py-1 bg-muted rounded",children:"F11"})," Fullscreen"]})]})})]})]})}export{je as default};
