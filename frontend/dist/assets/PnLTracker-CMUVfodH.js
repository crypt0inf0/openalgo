import{r as a,aV as O,aW as U,aX as $,aY as D,t as y,j as e,aZ as B,au as H,k as V,aA as X,a as q,a_ as K}from"./vendor-react-BtnKiOrb.js";import{u as Y,B as F}from"./index-B87L8flj.js";import{C as u,b as g,c as p,a as b}from"./card-DaWziHEX.js";async function Z(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function f(j){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(j)}function ee(){const{mode:j}=Y(),n=j==="dark",[v,S]=a.useState(!1),[T,L]=a.useState(!1),[l,_]=a.useState({currentMtm:0,maxMtm:0,maxMtmTime:"--:--",minMtm:0,minMtmTime:"--:--",maxDrawdown:0}),N=a.useRef(null),C=a.useRef(null),i=a.useRef(null),M=a.useRef(null),k=a.useRef(null),P=a.useRef(null),w=a.useCallback(()=>{if(!N.current)return;i.current&&(i.current.remove(),i.current=null);const s=N.current,c=O(s,{width:s.offsetWidth,height:500,layout:{background:{type:$.Solid,color:"transparent"},textColor:n?"#a6adbb":"#333"},grid:{vertLines:{color:n?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)",style:1,visible:!0},horzLines:{color:n?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)",style:1,visible:!0}},rightPriceScale:{borderColor:n?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:n?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:!0,secondsVisible:!1,tickMarkFormatter:h=>{const I=new Date(h*1e3),W=5.5*60*60*1e3,R=new Date(I.getTime()+W),z=R.getUTCHours().toString().padStart(2,"0"),A=R.getUTCMinutes().toString().padStart(2,"0");return`${z}:${A}`}},crosshair:{mode:U.Normal,vertLine:{width:1,color:n?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!1},horzLine:{width:1,color:n?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:n?"#1f2937":"#2563eb"}}}),t=document.createElement("div");t.style.position="absolute",t.style.zIndex="2",t.style.color=n?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.15)",t.style.fontFamily="Arial, sans-serif",t.style.fontSize="48px",t.style.fontWeight="bold",t.style.userSelect="none",t.style.pointerEvents="none",t.textContent="OpenAlgo",s.appendChild(t),P.current=t;const r=()=>{!t||!s||(t.style.left=`${s.offsetWidth/2-t.offsetWidth/2}px`,t.style.top=`${s.offsetHeight/2-t.offsetHeight/2}px`)};setTimeout(r,0);const d=c.addSeries(D,{lineColor:"#570df8",topColor:"rgba(87, 13, 248, 0.4)",bottomColor:"rgba(87, 13, 248, 0.0)",lineWidth:2,priceScaleId:"right",priceFormat:{type:"custom",formatter:h=>f(h)}}),o=c.addSeries(D,{lineColor:"#f000b8",topColor:"rgba(240, 0, 184, 0.0)",bottomColor:"rgba(240, 0, 184, 0.4)",lineWidth:2,priceScaleId:"right",priceFormat:{type:"custom",formatter:h=>f(h)}});i.current=c,M.current=d,k.current=o;const m=()=>{i.current&&s&&(i.current.applyOptions({width:s.offsetWidth}),r())};return window.addEventListener("resize",m),()=>{window.removeEventListener("resize",m)}},[n]),x=a.useCallback(async()=>{S(!0);try{const s=await Z(),c=await fetch("/pnltracker/api/pnl",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":s},credentials:"include"});if(!c.ok)throw new Error("Failed to fetch PnL data");const t=await c.json();if(t.status==="success"){const r=t.data;if(_({currentMtm:r.current_mtm,maxMtm:r.max_mtm,maxMtmTime:r.max_mtm_time||"--:--",minMtm:r.min_mtm,minMtmTime:r.min_mtm_time||"--:--",maxDrawdown:r.max_drawdown}),M.current&&r.pnl_series&&Array.isArray(r.pnl_series)){const d=r.pnl_series.map(o=>({time:Math.floor(o.time/1e3),value:o.value})).sort((o,m)=>o.time-m.time);d.length>0&&M.current.setData(d)}if(k.current&&r.drawdown_series&&Array.isArray(r.drawdown_series)){const d=r.drawdown_series.map(o=>({time:Math.floor(o.time/1e3),value:o.value})).sort((o,m)=>o.time-m.time);d.length>0&&k.current.setData(d)}i.current&&i.current.timeScale().fitContent()}else y.error(t.message||"Failed to load PnL data")}catch(s){console.error("Error loading PnL data:",s),y.error("Failed to load PnL data. Please try again.")}finally{S(!1)}},[]),E=async()=>{if(C.current){L(!0);try{(await K(C.current,{backgroundColor:n?"#1f2937":"#ffffff",scale:2,logging:!1,useCORS:!0})).toBlob(c=>{if(!c)return;const t=URL.createObjectURL(c),r=document.createElement("a"),d=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);r.download=`PnL_Tracker_${d}.png`,r.href=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t),y.success("Screenshot saved successfully!")},"image/png",1)}catch(s){console.error("Screenshot error:",s),y.error("Failed to capture screenshot")}finally{L(!1)}}};return a.useEffect(()=>(w(),x(),()=>{i.current&&(i.current.remove(),i.current=null)}),[w,x]),a.useEffect(()=>{i.current&&(w(),x())},[w,x]),e.jsxs("div",{className:"container mx-auto py-6 px-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"PnL Tracker"}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor your intraday profit and loss"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{variant:"secondary",onClick:E,disabled:T,children:T?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"Capturing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Screenshot"]})}),e.jsx(F,{onClick:x,disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Refresh"]})})]})]}),e.jsxs("div",{ref:C,children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsxs(u,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(p,{className:"text-sm font-medium text-muted-foreground",children:"Current MTM"})}),e.jsxs(b,{children:[e.jsx("div",{className:`text-2xl font-bold font-mono ${l.currentMtm>=0?"text-green-500":"text-red-500"}`,children:f(l.currentMtm)}),e.jsxs("div",{className:`text-sm ${l.currentMtm>=0?"text-green-500":"text-red-500"}`,children:[l.currentMtm>=0?"+":"",(l.currentMtm/1e5*100).toFixed(2),"%"]})]})]}),e.jsxs(u,{children:[e.jsx(g,{className:"pb-2",children:e.jsxs(p,{className:"text-sm font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(V,{className:"h-4 w-4 text-green-500"}),"Max MTM"]})}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold font-mono text-green-500",children:f(l.maxMtm)}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["at ",l.maxMtmTime]})]})]}),e.jsxs(u,{children:[e.jsx(g,{className:"pb-2",children:e.jsxs(p,{className:"text-sm font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4 text-red-500"}),"Min MTM"]})}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold font-mono text-red-500",children:f(l.minMtm)}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["at ",l.minMtmTime]})]})]}),e.jsxs(u,{children:[e.jsx(g,{className:"pb-2",children:e.jsxs(p,{className:"text-sm font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(q,{className:"h-4 w-4 text-yellow-500"}),"Max Drawdown"]})}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold font-mono text-yellow-500",children:f(Math.abs(l.maxDrawdown))}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Peak to trough"})]})]})]}),e.jsxs(u,{children:[e.jsx(g,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(p,{children:"Intraday PnL Curve"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-[#570df8]"}),"MTM PnL"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-[#f000b8]"}),"Drawdown"]})]})]})}),e.jsx(b,{children:e.jsx("div",{ref:N,className:"relative",style:{height:"500px"}})})]})]}),v&&e.jsx("div",{className:"fixed inset-0 bg-background/50 z-50 flex items-center justify-center",children:e.jsx(u,{className:"p-8",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("span",{className:"text-lg",children:"Loading PnL data..."})]})})})]})}export{ee as default};
