import{r as o,j as e,b7 as se,b4 as te,b8 as ne,au as ae,Z as re,b9 as ce,ba as ie,aP as oe,t as le}from"./vendor-react-BtnKiOrb.js";import{e as L,B as p,c as de}from"./index-B87L8flj.js";import{C as j,b as v,c as S,a as C}from"./card-DaWziHEX.js";import{I as ue}from"./input-fipynuSj.js";import{L as I}from"./label-C7siTT_u.js";import{S as me,a as he,b as xe,c as fe,d as J}from"./select-Dmte1kG2.js";async function pe(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}const ge=["NSE","NFO","BSE","BFO","CDS","MCX"];function b(d){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(d)}function be(d){return new Intl.NumberFormat("en-IN").format(d)}function je(d){return d?new Date(d).toLocaleTimeString("en-IN",{timeZone:"Asia/Kolkata",hour12:!0,hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-"}function Ce(){const[d,E]=o.useState(!1),[P,y]=o.useState(!1),h=o.useRef(null),[x,g]=o.useState(new Map),[N,M]=o.useState(""),[W,B]=o.useState(""),[F,A]=o.useState([]),[X,w]=o.useState(!1),[H,O]=o.useState(!1),[q,U]=o.useState([]),_=o.useRef(null),T=o.useRef(null),c=o.useCallback((s,t="info")=>{const a=new Date().toLocaleTimeString("en-IN");U(i=>[...i.slice(-99),{timestamp:a,message:s,type:t}])},[]),z=async()=>await pe(),K=async()=>{if(h.current?.readyState===WebSocket.OPEN){c("Already connected to WebSocket","info");return}y(!0),c("Attempting to connect to WebSocket server...","info");try{const s=await z(),a=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":s},credentials:"include"})).json();if(a.status!=="success")throw new Error("Failed to get WebSocket configuration");const i=a.websocket_url;c(`Connecting to ${i}...`,"info");const r=new WebSocket(i);r.onopen=async()=>{c("Connected to WebSocket server","success"),E(!0),y(!1);try{const n=await z(),u=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":n},credentials:"include"})).json();u.status==="success"&&u.api_key?(r.send(JSON.stringify({action:"authenticate",api_key:u.api_key})),c("Sent authentication request","info")):c("Failed to get API key. Go to /apikey to generate one.","error")}catch(n){c(`Error getting API key: ${n}`,"error")}},r.onclose=n=>{E(!1),y(!1),n.wasClean?c("WebSocket connection closed cleanly","info"):c(`WebSocket connection lost. Code: ${n.code}`,"error")},r.onerror=()=>{c("WebSocket error occurred","error"),y(!1)},r.onmessage=n=>{try{const l=JSON.parse(n.data);V(l)}catch(l){c(`Error parsing WebSocket message: ${l}`,"error")}},h.current=r}catch(s){c(`Error connecting: ${s}`,"error"),y(!1)}},V=o.useCallback(s=>{const t=s.type||s.status;switch(t){case"auth":s.status==="success"?c("WebSocket authentication successful","success"):c(`Authentication failed: ${s.message}`,"error");break;case"market_data":{const a=s.symbol.toLowerCase(),i=s.exchange,r=s.mode,n=s.data||{};g(l=>{const u=`${i}:${a.toUpperCase()}`,f=l.get(u);if(!f)return l;const k=new Map(l),m={...f.data};return(r===1||r===2)&&(n.ltp!==void 0&&(m.ltp=n.ltp),n.open!==void 0&&(m.open=n.open),n.high!==void 0&&(m.high=n.high),n.low!==void 0&&(m.low=n.low),n.close!==void 0&&(m.close=n.close),n.volume!==void 0&&(m.volume=n.volume),n.average_price!==void 0&&(m.average_price=n.average_price),n.last_trade_quantity!==void 0&&(m.last_trade_quantity=n.last_trade_quantity),n.total_buy_quantity!==void 0&&(m.total_buy_quantity=n.total_buy_quantity),n.total_sell_quantity!==void 0&&(m.total_sell_quantity=n.total_sell_quantity),n.timestamp!==void 0&&(m.timestamp=n.timestamp)),r===3&&n.depth&&(m.depth=n.depth),k.set(u,{...f,data:m}),k});break}case"subscribe":s.status==="success"?c("Subscription successful","success"):c(`Subscription error: ${s.message}`,"error");break;case"unsubscribe":c("Unsubscription processed","info");break;case"error":c(`WebSocket error: ${s.message}`,"error");break;default:c(`Unknown message type: ${t}`,"info")}},[c]),$=(s,t,a)=>{if(!h.current||h.current.readyState!==WebSocket.OPEN){c("Please connect to WebSocket first","error");return}const i={action:"subscribe",symbols:[{symbol:s,exchange:t}],mode:a};h.current.send(JSON.stringify(i)),c(`Subscribing to ${t}:${s} (${a})`,"info"),g(r=>{const n=`${t}:${s}`,l=r.get(n);if(!l)return r;const u=new Map(r),f=new Set(l.subscriptions);return f.add(a),u.set(n,{...l,subscriptions:f}),u})},G=(s,t,a)=>{if(!h.current||h.current.readyState!==WebSocket.OPEN)return;const r={action:"unsubscribe",symbols:[{symbol:s,exchange:t,mode:{LTP:1,Quote:2,Depth:3}[a]}],mode:a};h.current.send(JSON.stringify(r)),c(`Unsubscribing from ${t}:${s} (${a})`,"info"),g(n=>{const l=`${t}:${s}`,u=n.get(l);if(!u)return n;const f=new Map(n),k=new Set(u.subscriptions);return k.delete(a),f.set(l,{...u,subscriptions:k}),f})},R=s=>{let t=0;x.forEach((a,i)=>{const[r,n]=i.split(":");setTimeout(()=>$(n,r,s),t),t+=200})},Z=()=>{!h.current||h.current.readyState!==WebSocket.OPEN||(h.current.send(JSON.stringify({action:"unsubscribe_all"})),c("Unsubscribed from all symbols","info"),g(s=>{const t=new Map(s);return t.forEach((a,i)=>{t.set(i,{...a,subscriptions:new Set})}),t}))},Q=o.useCallback(async(s,t)=>{if(s.length<2){A([]),w(!1);return}O(!0);try{const a=new URLSearchParams({q:s});t&&a.append("exchange",t);const r=await(await fetch(`/search/api/search?${a}`,{credentials:"include"})).json();A((r.results||[]).slice(0,10)),w(!0)}catch(a){console.error("Search error:",a),A([])}finally{O(!1)}},[]);o.useEffect(()=>{const s=setTimeout(()=>{N.length>=2&&Q(N,W)},300);return()=>clearTimeout(s)},[N,W,Q]);const Y=(s,t)=>{const a=`${t}:${s}`;if(x.has(a)){le.error("Symbol already added");return}g(i=>{const r=new Map(i);return r.set(a,{symbol:s,exchange:t,data:{},subscriptions:new Set}),r}),M(""),w(!1),c(`Added symbol: ${a}`,"success")},D=(s,t)=>{const a=`${t}:${s}`,i=x.get(a);i&&i.subscriptions.forEach(r=>{G(s,t,r)}),g(r=>{const n=new Map(r);return n.delete(a),n}),c(`Removed symbol: ${a}`,"info")},ee=()=>{U([])};return o.useEffect(()=>{const s=t=>{T.current&&!T.current.contains(t.target)&&w(!1)};return document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[]),o.useEffect(()=>{_.current&&(_.current.scrollTop=_.current.scrollHeight)},[]),o.useEffect(()=>{const s=localStorage.getItem("websocket_active_symbols");if(s)try{const t=JSON.parse(s),a=new Map;t.forEach(i=>{const[r,n]=i.split(":");a.set(i,{symbol:n,exchange:r,data:{},subscriptions:new Set})}),g(a)}catch(t){console.error("Error loading saved symbols:",t)}},[]),o.useEffect(()=>{const s=Array.from(x.keys());localStorage.setItem("websocket_active_symbols",JSON.stringify(s))},[x]),e.jsxs("div",{className:"container mx-auto py-6 px-4 space-y-6",children:[e.jsx(j,{children:e.jsxs(v,{children:[e.jsx(S,{className:"text-3xl",children:"WebSocket Market Data Test"}),e.jsx("p",{className:"text-muted-foreground",children:"Real-time testing for multiple symbols with dynamic symbol management"})]})}),e.jsxs(j,{children:[e.jsx(v,{children:e.jsx(S,{children:"Connection Status"})}),e.jsx(C,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"WebSocket:"}),d?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-semibold text-green-500",children:"Connected"})]}):P?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4 text-yellow-500 animate-pulse"}),e.jsx("span",{className:"font-semibold text-yellow-500",children:"Connecting..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-semibold text-red-500",children:"Disconnected"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Active Symbols:"}),e.jsx(L,{children:x.size})]})]})})]}),e.jsxs(j,{children:[e.jsx(v,{children:e.jsx(S,{children:"Symbol Management"})}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:"Add Symbol"}),e.jsxs("div",{className:"relative",ref:T,children:[e.jsx(ue,{type:"text",placeholder:"Search for symbol...",value:N,onChange:s=>M(s.target.value),onFocus:()=>N.length>=2&&w(!0)}),H&&e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:e.jsx(ae,{className:"h-4 w-4 animate-spin"})}),X&&F.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-background border rounded-lg shadow-lg max-h-64 overflow-y-auto",children:F.map((s,t)=>e.jsx("div",{className:"p-3 border-b last:border-b-0 hover:bg-muted cursor-pointer",onClick:()=>Y(s.symbol,s.exchange),children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.symbol}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.name})]}),e.jsx(L,{children:s.exchange})]})},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:"Exchange Filter"}),e.jsxs(me,{value:W,onValueChange:B,children:[e.jsx(he,{children:e.jsx(xe,{placeholder:"All Exchanges"})}),e.jsxs(fe,{children:[e.jsx(J,{value:"_all",children:"All Exchanges"}),ge.map(s=>e.jsx(J,{value:s,children:s},s))]})]})]})]}),e.jsxs("div",{children:[e.jsxs(I,{children:["Active Symbols (",x.size,")"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[Array.from(x.entries()).map(([s,t])=>e.jsxs(L,{variant:"secondary",className:"gap-1 py-1 px-2",children:[s,e.jsx("button",{onClick:()=>D(t.symbol,t.exchange),children:e.jsx(re,{className:"h-3 w-3"})})]},s)),x.size===0&&e.jsx("span",{className:"text-muted-foreground text-sm",children:"No symbols added"})]})]})]})]}),e.jsxs(j,{children:[e.jsx(v,{children:e.jsx(S,{children:"Control Panel"})}),e.jsx(C,{children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(p,{onClick:K,disabled:d||P,children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Connect WebSocket"]}),e.jsx(p,{onClick:()=>R("LTP"),variant:"outline",disabled:!d,children:"Subscribe All LTP"}),e.jsx(p,{onClick:()=>R("Quote"),variant:"outline",disabled:!d,children:"Subscribe All Quote"}),e.jsx(p,{onClick:()=>R("Depth"),variant:"outline",disabled:!d,children:"Subscribe All Depth"}),e.jsxs(p,{onClick:Z,variant:"destructive",disabled:!d,children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Unsubscribe All"]})]})})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:Array.from(x.entries()).map(([s,t])=>e.jsxs(j,{children:[e.jsx(v,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(S,{children:s}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(p,{size:"sm",variant:"outline",onClick:()=>$(t.symbol,t.exchange,"LTP"),children:"LTP"}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>$(t.symbol,t.exchange,"Quote"),children:"Quote"}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>$(t.symbol,t.exchange,"Depth"),children:"Depth"})]})]})}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm mb-2",children:"Last Traded Price"}),e.jsx("div",{className:"text-2xl font-bold font-mono",children:t.data.ltp!==void 0?b(t.data.ltp):"-"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:je(t.data.timestamp)})]}),e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm mb-2",children:"Quote"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Open:"})," ",e.jsx("span",{className:"font-mono",children:t.data.open!==void 0?b(t.data.open):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"High:"})," ",e.jsx("span",{className:"font-mono",children:t.data.high!==void 0?b(t.data.high):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Low:"})," ",e.jsx("span",{className:"font-mono",children:t.data.low!==void 0?b(t.data.low):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Close:"})," ",e.jsx("span",{className:"font-mono",children:t.data.close!==void 0?b(t.data.close):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Volume:"})," ",e.jsx("span",{className:"font-mono",children:t.data.volume!==void 0?be(t.data.volume):"-"})]})]})]}),t.data.depth&&e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm mb-2",children:"Market Depth"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-green-500 mb-1",children:"BUY"}),t.data.depth.buy.slice(0,5).map((a,i)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:b(a.price)}),e.jsx("span",{className:"text-green-500",children:a.quantity})]},i))]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-red-500 mb-1",children:"SELL"}),t.data.depth.sell.slice(0,5).map((a,i)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:b(a.price)}),e.jsx("span",{className:"text-red-500",children:a.quantity})]},i))]})]})]})]})]},s))}),e.jsxs(j,{children:[e.jsx(v,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(S,{children:"Event Log"}),e.jsxs(p,{variant:"ghost",size:"sm",onClick:ee,children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Clear"]})]})}),e.jsx(C,{children:e.jsx("div",{ref:_,className:"h-64 overflow-y-auto bg-muted rounded-lg p-4 font-mono text-xs space-y-1",children:q.length===0?e.jsx("div",{className:"text-muted-foreground",children:"Waiting for events..."}):q.map((s,t)=>e.jsxs("div",{className:de(s.type==="success"&&"text-green-500",s.type==="error"&&"text-red-500",s.type==="data"&&"text-yellow-500",s.type==="info"&&"text-blue-500"),children:["[",s.timestamp,"] ",s.message]},t))})})]})]})}export{Ce as default};
